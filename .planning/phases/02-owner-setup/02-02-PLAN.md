---
phase: 02-owner-setup
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/app/api/staff/route.ts
  - src/app/dashboard/owner/team/page.tsx
autonomous: true
requirements:
  - AUTH-03
  - AUTH-04

must_haves:
  truths:
    - "Owner can create a manager account by entering email and password in the team management page"
    - "Manager can log in with the credentials the owner set and land on /dashboard/manager"
    - "Manager cannot access /dashboard/owner or any owner-only routes"
    - "Owner sees a list of managers they have created"
  artifacts:
    - path: "src/app/api/staff/route.ts"
      provides: "POST endpoint for manager creation using service role admin API"
      exports: ["POST"]
    - path: "src/app/dashboard/owner/team/page.tsx"
      provides: "Team management page with manager creation form and manager list"
  key_links:
    - from: "src/app/dashboard/owner/team/page.tsx"
      to: "src/app/api/staff/route.ts"
      via: "fetch POST from client component"
      pattern: "fetch.*api/staff"
    - from: "src/app/api/staff/route.ts"
      to: "src/lib/supabase/service.ts"
      via: "Service role client for auth.admin.createUser"
      pattern: "createServiceClient|auth\\.admin\\.createUser"
---

<objective>
Create the manager account creation flow: a Route Handler that uses the service role admin API to create manager auth users, and an owner dashboard page for managing team members.

Purpose: Enables restaurant owners to create manager accounts that can access only the manager panel — completing the role-based access control story.

Output: Working manager creation and login flow. Owner can create managers, managers can log in to /dashboard/manager.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-owner-setup/02-RESEARCH.md
@.planning/phases/02-owner-setup/02-01-SUMMARY.md
@src/lib/supabase/service.ts
@src/lib/supabase/server.ts
@src/lib/actions/auth.ts
@src/app/dashboard/owner/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Manager creation Route Handler</name>
  <files>
    src/app/api/staff/route.ts
  </files>
  <action>
    Create a POST Route Handler at `src/app/api/staff/route.ts` that creates a manager account:

    1. **Verify caller is an authenticated owner:**
       - Use `createClient()` from `@/lib/supabase/server` to call `auth.getUser()` — reject 401 if not authenticated
       - Call `auth.getSession()` to get the access_token, decode with `jwtDecode` to read `app_role` and `restaurant_id`
       - If `app_role !== 'owner'` or `restaurant_id` is missing → return 403

    2. **Parse and validate request body:**
       - Extract `{ email, password }` from `request.json()`
       - Validate with Zod: email must be valid, password min 8 chars
       - Return 400 with validation errors if invalid

    3. **Create manager auth user:**
       - Use `createServiceClient()` from `@/lib/supabase/service`
       - Call `serviceClient.auth.admin.createUser({ email, password, email_confirm: true })` — `email_confirm: true` skips the email verification step (owner is setting password directly)
       - On error, return 400 with the Supabase error message

    4. **Insert restaurant_staff row:**
       - Use service client to insert `{ restaurant_id: claims.restaurant_id, user_id: newUser.user.id, role: 'manager' }`
       - **Atomicity**: If staff insert fails, call `serviceClient.auth.admin.deleteUser(newUser.user.id)` to clean up the orphaned auth user
       - Return 500 on failure

    5. **Return 201 with `{ success: true, manager: { id, email } }`**

    Also create a GET handler in the same file to list managers for the authenticated owner's restaurant:
    - Verify caller is authenticated owner (same pattern as POST)
    - Query `restaurant_staff` where `restaurant_id = claims.restaurant_id` and `role = 'manager'` and `deleted_at IS NULL`
    - Join with `auth.users` is not possible via client SDK — instead, query `restaurant_staff` for the list and return `{ id, user_id, role, created_at }`
    - Return 200 with the list
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists: `ls src/app/api/staff/route.ts`
    - Grep for `auth.admin.createUser` — must exist
    - Grep for `email_confirm: true` — must exist
    - Grep for `auth.admin.deleteUser` — must exist (cleanup pattern)
    - Grep for `getUser` — must exist (auth verification)
  </verify>
  <done>
    POST /api/staff creates a manager auth user + restaurant_staff row atomically. GET /api/staff returns the list of managers for the owner's restaurant. Both endpoints verify the caller is an authenticated owner.
  </done>
</task>

<task type="auto">
  <name>Task 2: Owner team management page</name>
  <files>
    src/app/dashboard/owner/team/page.tsx
  </files>
  <action>
    Create `src/app/dashboard/owner/team/page.tsx` — a client component for managing team members:

    1. **Manager creation form:**
       - Fields: email (type="email"), password (type="password", min 8 chars)
       - On submit, POST to `/api/staff` with `{ email, password }` as JSON
       - Show loading state during submission (disable button, show "Criando...")
       - On success, show success toast/message ("Gerente criado com sucesso"), clear form, refresh manager list
       - On error, show the error message returned by the API

    2. **Manager list:**
       - On mount, GET `/api/staff` to fetch the list of managers
       - Display as a simple table/list: created_at date and user_id (or a masked identifier)
       - Show "Nenhum gerente cadastrado" if list is empty
       - Note: We cannot show the manager's email directly from `restaurant_staff` — the API returns `user_id`. For POC, show the user_id or add a `display_name` note. Alternatively, the POST response can return the email, so store created managers in local state.

    3. **UX:**
       - Page heading: "Equipe"
       - Section heading for form: "Adicionar Gerente"
       - Section heading for list: "Gerentes"
       - All text in pt-BR

    Note: The navigation link to `/dashboard/owner/team` ("Equipe") is already created in the owner layout by Plan 02-01. Do NOT modify `src/app/dashboard/owner/layout.tsx` — it is owned by Plan 02-01.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists: `ls src/app/dashboard/owner/team/page.tsx`
    - Grep for `api/staff` in the team page — must have both POST and GET fetch calls
    - Grep for `Equipe` or `Adicionar Gerente` — pt-BR text present
  </verify>
  <done>
    Owner can navigate to /dashboard/owner/team, create a manager account with email and password, and see the list of created managers. The created manager can log in via /login and land on /dashboard/manager.
  </done>
</task>

</tasks>

<verification>
With Supabase running and an owner account created (from Plan 02-01):
1. Log in as owner, navigate to /dashboard/owner/team
2. Fill in email and password for a new manager, submit
3. Log out, log in with the manager credentials — should land on /dashboard/manager
4. As manager, navigate to /dashboard/owner — should redirect to /login
5. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Owner can create manager accounts from the team page
- Manager creation is atomic (auth user + staff row, with cleanup on failure)
- Manager can log in and access only /dashboard/manager
- Manager cannot access /dashboard/owner
</success_criteria>

<output>
After completion, create `.planning/phases/02-owner-setup/02-02-SUMMARY.md`
</output>
