---
phase: 02-owner-setup
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/lib/actions/restaurant.ts
  - src/app/dashboard/owner/settings/page.tsx
autonomous: true
requirements:
  - DASH-05
  - WL-01
  - WL-02
  - WL-04
  - WL-05

must_haves:
  truths:
    - "Owner can update program name, primary color, secondary color, and see changes persist after page reload"
    - "Owner can upload a logo image (JPEG, PNG, WebP, SVG, max 1MB) and see it displayed"
    - "Owner can configure earn rate (points per R$1)"
    - "Owner can select a reward type (cashback, free product, or progressive discount)"
    - "Owner can set point expiry days (or leave blank for no expiry)"
    - "Owner can manage ranks: name, visit threshold (min_visits), and multiplier per rank"
    - "No customer-facing surface contains the string 'REVISIT'"
  artifacts:
    - path: "src/lib/actions/restaurant.ts"
      provides: "Server Actions for branding update, logo upload, and ranks management"
      exports: ["updateBranding", "uploadLogo", "updateRanks"]
    - path: "src/app/dashboard/owner/settings/page.tsx"
      provides: "Settings page with branding config, program config, and ranks management sections"
  key_links:
    - from: "src/app/dashboard/owner/settings/page.tsx"
      to: "src/lib/actions/restaurant.ts#updateBranding"
      via: "useActionState + form action"
      pattern: "useActionState\\(updateBranding"
    - from: "src/lib/actions/restaurant.ts#uploadLogo"
      to: "supabase.storage.from('restaurant-logos')"
      via: "Supabase Storage SDK upload"
      pattern: "storage\\.from.*restaurant-logos"
    - from: "src/lib/actions/restaurant.ts#updateBranding"
      to: "supabase.from('restaurants').update"
      via: "RLS-protected update (owner's restaurant only)"
      pattern: "from.*restaurants.*update"
    - from: "src/lib/actions/restaurant.ts#updateRanks"
      to: "supabase.from('ranks')"
      via: "RLS-protected upsert/delete for ranks"
      pattern: "from.*ranks"
---

<objective>
Create the restaurant settings page where owners configure branding (name, colors, logo) and loyalty program parameters (earn rate, reward type, point expiry, ranks with multipliers and visit thresholds).

Purpose: This is the core configuration capability — every customer-facing surface and the points engine will read these settings. WL-01/WL-02/WL-04/WL-05 all depend on branding being persisted correctly.

Output: A fully functional settings page that persists all branding and program configuration to the database.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-owner-setup/02-RESEARCH.md
@.planning/phases/02-owner-setup/02-01-SUMMARY.md
@src/lib/supabase/server.ts
@src/lib/supabase/service.ts
@supabase/migrations/0005_branding.sql
@supabase/migrations/0006_storage.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restaurant configuration Server Actions</name>
  <files>
    src/lib/actions/restaurant.ts
  </files>
  <action>
    Create `src/lib/actions/restaurant.ts` with three Server Actions:

    **1. `updateBranding(prevState, formData)`:**
    - Validate with Zod:
      - `program_name`: string, min 1, max 100, trimmed
      - `primary_color`: string matching `/^#[0-9A-Fa-f]{6}$/`
      - `secondary_color`: string matching `/^#[0-9A-Fa-f]{6}$/`
      - `earn_rate`: coerce to int, min 1, max 100
      - `reward_type`: enum `['cashback', 'free_product', 'progressive_discount']`
      - `point_expiry_days`: coerce to int, min 0, nullable/optional (empty string → null)
    - Authenticate: `supabase.auth.getUser()` — reject if not authenticated
    - Get `restaurant_id` from JWT: decode session access_token with `jwtDecode`
    - Update `restaurants` table via the authenticated client (RLS ensures only owner's restaurant is affected): `supabase.from('restaurants').update(validated.data).eq('id', restaurantId)`
    - Call `revalidatePath('/dashboard/owner/settings')` on success
    - Return `{ success: true, message: 'Configuracoes salvas com sucesso' }` or `{ errors }` on validation failure or `{ message: 'Erro...' }` on DB error

    **2. `uploadLogo(prevState, formData)`:**
    - Extract file from `formData.get('logo') as File`
    - Validate: file must exist, `file.size <= 1_048_576` (1MB), `file.type` must be in `['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml']`
    - Authenticate and get restaurant_id (same pattern)
    - Upload to Supabase Storage: `supabase.storage.from('restaurant-logos').upload(`${restaurantId}/logo.${ext}`, file, { upsert: true, contentType: file.type })`
    - Get public URL: `supabase.storage.from('restaurant-logos').getPublicUrl(path)`
    - Update `restaurants.logo_url` with the public URL
    - Call `revalidatePath('/dashboard/owner/settings')`
    - Return success or error

    **3. `updateRanks(prevState, formData)`:**
    - This action receives the entire ranks configuration as a JSON string in a hidden form field (`formData.get('ranks_json')`)
    - Parse and validate with Zod: array of `{ id?: string, name: string, min_visits: number (>= 0), multiplier: number (> 0, max 10) }`, sorted by min_visits ascending
    - Authenticate and get restaurant_id
    - Strategy: Delete all existing ranks for this restaurant, then insert the new set. Use the service role client for this to avoid complications with RLS during delete+insert. Wrap in a transaction pattern: delete first, insert all new ranks with `sort_order` assigned by array index.
    - Alternative (simpler for POC): Use the authenticated client. Delete ranks where `restaurant_id = restaurantId` (RLS scopes this). Then insert all new ranks.
    - Call `revalidatePath('/dashboard/owner/settings')`
    - Return success or error

    **Helper function `getAuthenticatedOwner()`:**
    - Extract common auth + JWT decode logic into a helper used by all three actions
    - Returns `{ userId, restaurantId }` or throws/returns error
    - Uses `createClient()` from `@/lib/supabase/server`, calls `getUser()`, then `getSession()`, decodes JWT, verifies `app_role === 'owner'`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists: `ls src/lib/actions/restaurant.ts`
    - Grep for `updateBranding` — exported Server Action
    - Grep for `uploadLogo` — exported Server Action
    - Grep for `updateRanks` — exported Server Action
    - Grep for `'use server'` at top of file
    - Grep for `revalidatePath` — must be called after each successful update
    - Grep for `restaurant-logos` — storage bucket name in uploadLogo
    - Grep for Zod validation (`z.object`, `safeParse`) — must exist
  </verify>
  <done>
    Three Server Actions exist: updateBranding persists program name/colors/earn rate/reward type/expiry to restaurants table, uploadLogo uploads to Supabase Storage and saves public URL, updateRanks replaces the ranks configuration. All validate inputs with Zod and authenticate the caller.
  </done>
</task>

<task type="auto">
  <name>Task 2: Owner settings page with branding, program config, and ranks management</name>
  <files>
    src/app/dashboard/owner/settings/page.tsx
  </files>
  <action>
    Create `src/app/dashboard/owner/settings/page.tsx`. This page has three sections. Use a mix of Server Component (for loading data) and Client Components (for forms).

    **Data loading (Server Component wrapper or top-level async component):**
    - Fetch current restaurant data: `supabase.from('restaurants').select('*').eq('id', restaurantId).single()`
    - Fetch current ranks: `supabase.from('ranks').select('*').eq('restaurant_id', restaurantId).is('deleted_at', null).order('sort_order')`
    - Get `restaurantId` by decoding the JWT from session (same helper pattern)
    - Pass data as props to client form components

    **Section 1: Branding form (Client Component — can be inline 'use client' component or extracted)**
    - Fields:
      - `program_name` — text input, prefilled with current value
      - `primary_color` — color input (`type="color"`), prefilled
      - `secondary_color` — color input, prefilled
    - Logo upload: separate form with file input (`accept="image/jpeg,image/png,image/webp,image/svg+xml"`) and current logo preview (if `logo_url` exists, show `<img>`)
    - Two separate forms: one for text/color fields (calls `updateBranding`), one for logo (calls `uploadLogo`)
    - Use `useActionState` for both forms

    **Section 2: Program configuration (part of the branding form or separate)**
    - Fields:
      - `earn_rate` — number input, min 1, max 100, step 1 (label: "Pontos por R$1 gasto")
      - `reward_type` — select dropdown with options: Cashback, Produto Gratis, Desconto Progressivo (values: cashback, free_product, progressive_discount)
      - `point_expiry_days` — number input, min 0 (label: "Dias para expirar pontos", placeholder: "Deixe vazio para nunca expirar")
    - These fields can be in the same form as branding (single `updateBranding` action handles all)

    **Section 3: Ranks management (Client Component)**
    - Display current ranks in an editable list/table
    - Each rank row: name (text input), min_visits (number input, label "Visitas minimas"), multiplier (number input, step 0.1, label "Multiplicador")
    - "Adicionar nivel" button to add a new rank row
    - "Remover" button on each rank (except if only one rank remains)
    - Save button submits all ranks via `updateRanks` — serialize the ranks array to JSON in a hidden field
    - Use `useActionState(updateRanks, undefined)` for the ranks form

    **Page heading:** "Configuracoes"
    **Section headings:** "Marca" (branding), "Programa" (program), "Niveis" (ranks)
    **All text in pt-BR**

    Add a navigation link to `/dashboard/owner/settings` in the owner layout nav (modify `src/app/dashboard/owner/layout.tsx` — add "Configuracoes" link alongside "Equipe" link from Plan 02-02).

    **White-label check (WL-02):** Ensure NO rendered text contains the string "REVISIT" in any customer-facing or owner-facing template. The settings page itself is owner-facing (not customer-facing) but should still not expose the platform name in the UI chrome — use "Painel" or restaurant name, not "REVISIT Dashboard".
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists: `ls src/app/dashboard/owner/settings/page.tsx`
    - Grep for `updateBranding` — form action wired
    - Grep for `uploadLogo` — logo form action wired
    - Grep for `updateRanks` — ranks form action wired
    - Grep for `useActionState` — must appear for form state management
    - Grep for `primary_color` — color input present
    - Grep for `earn_rate` — program config field present
    - Grep for `min_visits` — ranks field present
    - Grep for `multiplier` — ranks field present (alias: "Multiplicador")
    - Grep -i for `REVISIT` in `src/app/` — must return ZERO matches in any rendered text (imports/comments don't count)
  </verify>
  <done>
    Owner can visit /dashboard/owner/settings and configure: program name, colors, logo, earn rate, reward type, point expiry, and rank tiers (name, visit threshold, multiplier). All changes persist to the database and survive page reload. No customer-facing surface contains "REVISIT".
  </done>
</task>

</tasks>

<verification>
With Supabase running and an owner logged in:
1. Navigate to /dashboard/owner/settings
2. Change program name, colors, earn rate, reward type — save — reload page — values persist
3. Upload a logo (< 1MB JPEG/PNG) — logo preview appears after upload
4. Edit ranks: change names, visit thresholds, multipliers — save — reload — values persist
5. Add a new rank, remove a rank — save — changes persist
6. `grep -ri "REVISIT" src/app/` returns zero matches in rendered text
7. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- All branding fields (program_name, primary_color, secondary_color, logo_url) persist correctly
- All program fields (earn_rate, reward_type, point_expiry_days) persist correctly
- Ranks can be added, edited, and removed with name, min_visits, and multiplier
- Logo upload works with size/type validation
- No "REVISIT" string appears in any rendered customer-facing or owner-facing template
</success_criteria>

<output>
After completion, create `.planning/phases/02-owner-setup/02-03-SUMMARY.md`
</output>
