---
phase: 04-customer-experience-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0008_analytics.sql
  - src/app/[slug]/layout.tsx
  - src/app/[slug]/page.tsx
autonomous: true
requirements:
  - CARD-01

must_haves:
  truths:
    - "A customer visiting /{slug} sees a fully branded marketing page with the restaurant's logo, colors, and program name"
    - "No rendered HTML, title tag, or meta tag contains the string REVISIT"
    - "The page displays rank progression (Bronze, Prata, Gold, VIP) with colored badges"
    - "An invalid slug returns a not-found page"
  artifacts:
    - path: "supabase/migrations/0008_analytics.sql"
      provides: "Analytics indexes + generate_next_card_number RPC"
      contains: "idx_sales_restaurant_created"
    - path: "src/app/[slug]/layout.tsx"
      provides: "Tenant layout reading x-restaurant-id header"
      contains: "x-restaurant-id"
    - path: "src/app/[slug]/page.tsx"
      provides: "White-label landing page with generateMetadata"
      contains: "generateMetadata"
  key_links:
    - from: "src/app/[slug]/layout.tsx"
      to: "middleware x-restaurant-id header"
      via: "headers() from next/headers"
      pattern: "headers.*x-restaurant-id"
    - from: "src/app/[slug]/page.tsx"
      to: "restaurants table"
      via: "createServiceClient() query"
      pattern: "createServiceClient"
---

<objective>
Create the tenant landing page and supporting database migration for Phase 4.

Purpose: Customers visiting app.revisit.com/{slug} must see a fully white-labeled marketing page branded as the restaurant. This plan also adds database indexes and an RPC needed for analytics and card number generation.

Output: Migration file, tenant layout, and landing page with generateMetadata.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-experience-analytics/04-RESEARCH.md
@src/lib/supabase/middleware.ts
@src/lib/supabase/service.ts
@src/lib/utils/card-number.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for analytics indexes and card number generation RPC</name>
  <files>supabase/migrations/0008_analytics.sql</files>
  <action>
Create migration `0008_analytics.sql` with:

1. **Analytics indexes** for period filtering:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_sales_restaurant_created ON public.sales(restaurant_id, created_at DESC);
   CREATE INDEX IF NOT EXISTS idx_point_transactions_restaurant_created ON public.point_transactions(restaurant_id, created_at DESC);
   ```

2. **generate_next_card_number RPC** — SECURITY DEFINER function that atomically determines the next card number for a restaurant. This prevents race conditions during concurrent customer registrations.
   ```sql
   CREATE OR REPLACE FUNCTION public.generate_next_card_number(p_restaurant_id UUID)
   RETURNS TEXT
   LANGUAGE plpgsql
   SECURITY DEFINER
   SET search_path = ''
   AS $$
   DECLARE
     v_max_seq INTEGER;
     v_next_seq INTEGER;
     v_digits TEXT;
     v_check TEXT;
     v_sum INTEGER;
     v_d INTEGER;
   BEGIN
     -- Get current max sequence for this restaurant (including deleted customers)
     SELECT COALESCE(MAX(
       NULLIF(SUBSTRING(card_number FROM 2 FOR 4), '')::INTEGER
     ), 0)
     INTO v_max_seq
     FROM public.customers
     WHERE restaurant_id = p_restaurant_id;

     v_next_seq := v_max_seq + 1;

     IF v_next_seq > 9999 THEN
       RAISE EXCEPTION 'Card number sequence exhausted for restaurant %', p_restaurant_id;
     END IF;

     v_digits := LPAD(v_next_seq::TEXT, 4, '0');

     -- Compute Luhn check digit (same algorithm as card-number.ts)
     v_sum := 0;
     FOR i IN 1..4 LOOP
       v_d := SUBSTRING(v_digits FROM (5 - i) FOR 1)::INTEGER;
       IF (i - 1) % 2 = 1 THEN
         v_d := v_d * 2;
         IF v_d > 9 THEN v_d := v_d - 9; END IF;
       END IF;
       v_sum := v_sum + v_d;
     END LOOP;
     v_check := ((10 - (v_sum % 10)) % 10)::TEXT;

     RETURN '#' || v_digits || '-' || v_check;
   END;
   $$;

   -- Allow service role and authenticated to call (service role for customer registration)
   GRANT EXECUTE ON FUNCTION public.generate_next_card_number TO authenticated;
   GRANT EXECUTE ON FUNCTION public.generate_next_card_number TO service_role;
   ```

3. **Add `total_spend` column to customers** (denormalized, for analytics display without join):
   ```sql
   ALTER TABLE public.customers
     ADD COLUMN IF NOT EXISTS total_spend INTEGER NOT NULL DEFAULT 0;
   ```
   Also update register_sale RPC to increment total_spend. However, since register_sale is in 0007_loyalty_engine.sql and already deployed, create an updated version in this migration using CREATE OR REPLACE. Copy the existing register_sale body and add one line in step 11:
   ```sql
   -- After updating points_balance, visit_count, current_rank_id:
   total_spend = total_spend + p_amount_cents
   ```
   This is a surgical addition — the existing function signature and return type are unchanged.

Run `npx supabase db reset` after creating the migration to verify it applies cleanly.
  </action>
  <verify>
Run `npx supabase db reset` — must complete without errors. Verify indexes exist: `npx supabase db query "SELECT indexname FROM pg_indexes WHERE tablename = 'sales' AND indexname = 'idx_sales_restaurant_created';"` returns a row.
  </verify>
  <done>Migration applies cleanly, indexes exist, generate_next_card_number function exists and is callable, total_spend column exists on customers table.</done>
</task>

<task type="auto">
  <name>Task 2: Tenant landing page — layout, generateMetadata, and white-label marketing page</name>
  <files>src/app/[slug]/layout.tsx, src/app/[slug]/page.tsx</files>
  <action>
**`src/app/[slug]/layout.tsx`** — Tenant layout:
- Read `x-restaurant-id` and `x-restaurant-name` from `await headers()` (Next.js 16 — headers() is async)
- If `x-restaurant-id` is missing, call `notFound()`
- Fetch restaurant branding using `createServiceClient()`: `program_name`, `primary_color`, `secondary_color`, `logo_url`, `earn_rate`, `reward_type`
- Also fetch ranks for this restaurant (from `active_ranks`, ordered by `sort_order ASC`)
- Pass branding data and ranks to children via a simple React context or direct prop pass. Since this is Server Component only, pass branding to page.tsx via a shared fetch pattern (page.tsx also fetches — that's fine, Supabase client caches within the same request).
- No "REVISIT" string anywhere in rendered HTML. Layout wraps children in a simple full-width container.

**`src/app/[slug]/page.tsx`** — Landing page:
- `generateMetadata` function: await `params` to get slug, fetch restaurant by slug using `createServiceClient()`, return `{ title: restaurant.program_name ?? restaurant.name, description: "Ganhe pontos..." }`. No "REVISIT" in any meta field.
- Page content (Server Component) fetches: restaurant branding (program_name, primary_color, secondary_color, logo_url, earn_rate), ranks (name, min_visits, multiplier, discount_pct, sort_order)
- Render a full marketing page layout per locked decisions:

  **Hero section:**
  - Restaurant logo at top (from `logo_url`, if null show program_name as text)
  - Restaurant's `primary_color` as background, white text
  - Headline: `program_name ?? name` in large text
  - Subheadline: "Ganhe pontos toda vez que nos visitar!" (casual pt-BR)
  - CTA button: "Cadastre-se Gratis" — this button will be wired to open the registration modal in Plan 04-02. For now, render it as a `<button>` with `id="cta-register"` and `data-action="open-register"` so Plan 02 can attach the modal behavior.

  **How it works section:** White background
  - 3 steps: "1. Cadastre-se" / "2. Compre e acumule pontos" / "3. Troque por recompensas"
  - Each step has a number badge and brief description

  **Rank progression section:**
  - Display each rank from the DB as a colored badge card
  - Rank colors: Bronze (#CD7F32), Prata (#C0C0C0), Gold (#FFD700), VIP (#9b59b6) — map by sort_order (1=Bronze, 2=Prata, 3=Gold, 4=VIP) or use rank name
  - Each card shows: rank name, "A partir de X visitas", multiplier "Xx pontos"
  - Use the restaurant's `primary_color` for borders/accents

  **Benefits section:**
  - "Por que participar?" heading
  - 3-4 benefit bullets: "Pontos em toda compra", "Descontos exclusivos", "Promoções especiais", etc.

  **Footer CTA:**
  - Repeat the CTA button at bottom
  - Restaurant name in footer, no REVISIT branding

- All copy in pt-BR, informal (voce). Warm, casual tone.
- Style with inline styles (project convention) — primary_color as dominant accent, white content areas.
- Pass `restaurantId` (from header) as a data attribute on the CTA button so Plan 02's modal can read it.
  </action>
  <verify>
1. Run `npm run build` — page compiles without errors.
2. Start dev server, visit `http://localhost:3000/{seed-restaurant-slug}` — landing page renders with restaurant branding.
3. View page source — no "REVISIT" string in any HTML or meta tag.
4. Visit `http://localhost:3000/nonexistent-slug` — returns not-found page.
  </verify>
  <done>Landing page renders at /{slug} with restaurant's logo, colors, program name, rank progression, benefits, and CTA button. No REVISIT branding anywhere in rendered output. Invalid slugs return 404.</done>
</task>

</tasks>

<verification>
1. `npx supabase db reset` passes — migration 0008 applies cleanly
2. `npm run build` succeeds with no TypeScript errors
3. Landing page at `/{slug}` shows branded content using restaurant's primary_color, logo, ranks
4. `grep -ri "revisit" src/app/\[slug\]/` returns zero matches in rendered content (only import paths allowed)
5. generateMetadata produces correct title and description without REVISIT
</verification>

<success_criteria>
- Migration 0008 deployed with analytics indexes, generate_next_card_number RPC, and total_spend column
- /{slug} renders a full marketing landing page branded entirely as the restaurant
- No REVISIT string in any HTML, title, or meta tag on tenant pages
- Rank progression displayed with colored badges
- CTA button present and ready for registration modal (Plan 04-02)
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-experience-analytics/04-01-SUMMARY.md`
</output>
