---
phase: 04-customer-experience-analytics
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/dashboard/owner/layout.tsx
  - src/app/dashboard/owner/analytics/page.tsx
  - src/app/dashboard/owner/analytics/PeriodSelector.tsx
  - src/app/dashboard/owner/analytics/RankDonutChart.tsx
  - src/app/dashboard/owner/customers/page.tsx
  - src/app/dashboard/owner/customers/CustomerPanel.tsx
  - src/app/dashboard/owner/logs/page.tsx
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
  - DASH-04

must_haves:
  truths:
    - "Owner can view total customers, total points issued, total sales count, and total revenue"
    - "Owner can see rank distribution as a donut chart"
    - "Owner can filter analytics by period: 7d, 30d, 90d, all time"
    - "Owner can search customers by name, phone, or card number"
    - "Owner can browse paginated customer list with rank, points, visits, total spend, and registration date"
    - "Owner can click a customer row to see full details in a side panel"
    - "Owner can view full sales log with customer name, card number, value, points credited, manager, and timestamp"
    - "Owner can view manager audit log showing all point transactions with manager attribution"
    - "Sales log and audit log are separate tabs"
  artifacts:
    - path: "src/app/dashboard/owner/analytics/page.tsx"
      provides: "Analytics overview with stat cards and rank donut chart"
      contains: "searchParams"
    - path: "src/app/dashboard/owner/analytics/RankDonutChart.tsx"
      provides: "Donut chart for rank distribution"
      contains: "PieChart"
    - path: "src/app/dashboard/owner/analytics/PeriodSelector.tsx"
      provides: "Period filter navigation (7d/30d/90d/all)"
      contains: "useRouter"
    - path: "src/app/dashboard/owner/customers/page.tsx"
      provides: "Searchable paginated customer list"
      contains: "searchParams"
    - path: "src/app/dashboard/owner/customers/CustomerPanel.tsx"
      provides: "Slide-out customer detail panel"
      contains: "CustomerPanel"
    - path: "src/app/dashboard/owner/logs/page.tsx"
      provides: "Sales log + audit log tabs"
      contains: "searchParams"
  key_links:
    - from: "src/app/dashboard/owner/analytics/page.tsx"
      to: "active_customers, active_sales, active_point_transactions views"
      via: "supabase queries with period filter"
      pattern: "gte.*created_at"
    - from: "src/app/dashboard/owner/analytics/RankDonutChart.tsx"
      to: "src/app/dashboard/owner/analytics/page.tsx"
      via: "props (data passed from server component)"
      pattern: "RankDonutChart.*data"
    - from: "src/app/dashboard/owner/customers/page.tsx"
      to: "active_customers view"
      via: "supabase query with ILIKE search and range pagination"
      pattern: "ilike.*range"
---

<objective>
Build the owner analytics dashboard: overview metrics, customer list with search and detail panel, sales log, and manager audit log.

Purpose: Owners need visibility into their loyalty program — how many customers, how many points issued, which ranks are popular, detailed customer and transaction history.

Output: Analytics overview page, customer list page with side panel, logs page with tabs.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-experience-analytics/04-RESEARCH.md
@src/app/dashboard/owner/layout.tsx
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sidebar navigation update + analytics overview page with stat cards and donut chart</name>
  <files>src/app/dashboard/owner/layout.tsx, src/app/dashboard/owner/analytics/page.tsx, src/app/dashboard/owner/analytics/PeriodSelector.tsx, src/app/dashboard/owner/analytics/RankDonutChart.tsx</files>
  <action>
**Install recharts:**
```bash
npm install recharts
```

**`src/app/dashboard/owner/layout.tsx`** — Update sidebar:
Add three new nav links after "Configuracoes":
- "Analises" → `/dashboard/owner/analytics`
- "Clientes" → `/dashboard/owner/customers`
- "Registros" → `/dashboard/owner/logs`

Keep existing links (Painel, Equipe, Configuracoes) and the Sair button. Same inline style pattern.

**`src/app/dashboard/owner/analytics/page.tsx`** — Analytics overview:
- Server Component. `searchParams` is a Promise in Next.js 16 — MUST await it.
- Read `period` from searchParams (default '30d'). Valid values: '7d', '30d', '90d', 'all'.
- Convert period to a `since` Date or null (null = all time):
  - '7d' → 7 days ago, '30d' → 30 days ago, '90d' → 90 days ago, 'all' → null
- Get authenticated client via `createClient()` from server.ts.
- Get restaurant_id from JWT claims (same pattern as owner layout: getUser → getSession → jwtDecode).
- Run analytics queries in parallel with `Promise.all`:

  **Stat cards (4 cards):**
  1. Total customers: `active_customers` count where `restaurant_id` matches (no date filter — total is all-time)
  2. Total points issued: query `active_point_transactions` where `transaction_type = 'earn'`, optionally filtered by `created_at >= since`. Sum `points_delta` client-side (POC scale — research confirms OK for <1000 rows).
  3. Total sales count: `active_sales` count with optional date filter
  4. Total revenue: query `active_sales` with optional date filter, sum `amount_cents` client-side. Display as R$ (divide by 100, format with 2 decimals).

  **Rank distribution (donut chart):**
  - Query `active_customers` with `current_rank_id` and join to `active_ranks` (name)
  - Group client-side by rank name, count per group
  - Pass as `{ name: string; value: number }[]` to RankDonutChart

- Render layout:
  - `<h1>Analises</h1>`
  - `<PeriodSelector current={period} />` at top
  - Stat cards in a 4-column grid (responsive: 2 cols on small screens)
  - Each card: label, large number, subtle period indicator
  - Format revenue as "R$ X.XXX,XX" (Brazilian format: dot for thousands, comma for decimals)
  - RankDonutChart below stat cards
  - All text in pt-BR: "Total de Clientes", "Pontos Emitidos", "Vendas", "Receita"

**`src/app/dashboard/owner/analytics/PeriodSelector.tsx`** — Client component:
- `'use client'`
- Props: `{ current: string }`
- Render 4 buttons: "7 dias", "30 dias", "90 dias", "Todos"
- Active button has primary styling (filled), others are outline
- On click: `router.push(\`/dashboard/owner/analytics?period=${value}\`)` using `useRouter` from `next/navigation`
- Use `useTransition` to show pending state during navigation

**`src/app/dashboard/owner/analytics/RankDonutChart.tsx`** — Client component:
- `'use client'`
- Import `PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer` from `recharts`
- Props: `{ data: { name: string; value: number }[] }`
- Rank colors: Bronze=#CD7F32, Prata=#C0C0C0, Gold=#FFD700, VIP=#9b59b6
- Use `ResponsiveContainer` for proper sizing (width="100%", height={280})
- Donut: `innerRadius={70}` `outerRadius={110}`
- Show total customer count in center using absolute-positioned text
- Tooltip: show count + "clientes"
- Legend at bottom
- Handle empty data: show "Nenhum cliente cadastrado" message
  </action>
  <verify>
1. `npm run build` — compiles without errors
2. Log in as owner, navigate to /dashboard/owner/analytics — stat cards render with correct numbers from seed data
3. Click period buttons — URL updates, data refreshes
4. Donut chart displays rank distribution
5. Sidebar shows new nav links
  </verify>
  <done>Analytics overview displays stat cards (customers, points, sales, revenue) with period filtering and rank distribution donut chart. Sidebar navigation updated with Analises, Clientes, Registros links.</done>
</task>

<task type="auto">
  <name>Task 2: Searchable customer list with pagination and slide-out detail panel</name>
  <files>src/app/dashboard/owner/customers/page.tsx, src/app/dashboard/owner/customers/CustomerPanel.tsx</files>
  <action>
**`src/app/dashboard/owner/customers/page.tsx`** — Customer list:
- Server Component. Await `searchParams` (Promise in Next.js 16).
- Read from searchParams: `q` (search query, default ''), `page` (page number, default '1'), `selected` (selected customer ID for panel, default null).
- Page size: 25 rows.
- Get authenticated client and restaurant_id (same JWT pattern as analytics page).
- Build Supabase query:
  ```
  active_customers
    .select('id, name, phone, card_number, points_balance, visit_count, total_spend, created_at, current_rank_id', { count: 'exact' })
    .eq('restaurant_id', restaurantId)
    .order('created_at', { ascending: false })
    .range(from, to)
  ```
- If `q` is provided, add OR filter: `name.ilike.%${q}%,phone.ilike.%${q}%,card_number.ilike.%${q}%`
- For each customer row, also need rank name. Two options:
  - Option A: Separate query for ranks, then map client-side. Simpler.
  - Use Option A: query all `active_ranks` for this restaurant, build a `Map<rankId, rankName>`, then map each customer's `current_rank_id` to rank name.
- Render:
  - Search input at top (with debounced URL push — use a client component `SearchInput` inline):
    ```
    <form> with GET method and action="/dashboard/owner/customers"
    <input name="q" defaultValue={q} />
    ```
    Simple form submit for search — no JS-based debounce needed for POC. User presses Enter or clicks search button.
  - Table with columns: Nome, Telefone, Cartao, Nivel, Pontos, Visitas, Gasto Total, Cadastro
  - Format phone as (XX) XXXXX-XXXX for display
  - Format total_spend as R$ X.XXX,XX
  - Format created_at as DD/MM/YYYY
  - Each row is clickable: wraps in `<a href="/dashboard/owner/customers?q=${q}&page=${page}&selected=${customer.id}">`
  - Pagination controls at bottom: "Anterior" / "Proxima" links updating `page` searchParam
  - Show "X de Y clientes" count

- If `selected` is set, render `<CustomerPanel>` component.

**`src/app/dashboard/owner/customers/CustomerPanel.tsx`** — Client component:
- `'use client'`
- Props: `{ customerId: string; onClose: string }` where `onClose` is the URL without `selected` param (for closing the panel)
- Actually, since this is a Server Component page, make CustomerPanel a Server Component too — it can fetch data directly.
- Reconsider: Make it a Server Component that receives customerId as prop. The page passes it.
- Fetch customer details: full customer row + rank name
- Fetch recent transactions: `active_point_transactions` for this customer, ordered by created_at DESC, limit 20. Include transaction_type, points_delta, balance_after, note, created_at.
- Fetch recent sales for this customer: `active_sales` with staff join for manager info.
- Render as a fixed-position side panel (right side, ~400px wide, full height):
  - Customer name, phone, card number at top
  - Current rank badge (colored)
  - Stats: points balance, visit count, total spend, member since
  - Transaction history table: date, type (Compra/Resgate/Ajuste), points, balance
  - Close button: `<a href={closeUrl}>` (URL without selected param)
- Style: white background, shadow, overlaid on top of the table. Use inline styles.

All text in pt-BR.
  </action>
  <verify>
1. `npm run build` — compiles without errors
2. Navigate to /dashboard/owner/customers — customer list shows with columns
3. Search for a seed customer name — filtered results appear
4. Click a customer row — side panel slides in with details and transaction history
5. Click close — panel disappears
6. Pagination works when enough rows exist
  </verify>
  <done>Owner can search and browse paginated customer list with rank, points, visits, total spend, and registration date. Clicking a customer opens a side panel with full details and transaction history.</done>
</task>

<task type="auto">
  <name>Task 3: Sales log and manager audit log with tabs</name>
  <files>src/app/dashboard/owner/logs/page.tsx</files>
  <action>
**`src/app/dashboard/owner/logs/page.tsx`** — Logs page with tabs:
- Server Component. Await `searchParams`.
- Read from searchParams: `tab` (default 'vendas'), `page` (default '1'), `period` (default '30d').
- Get authenticated client and restaurant_id (same JWT pattern).
- Convert period to `since` date (same helper as analytics page — extract into a shared utility or duplicate the simple function).
- Page size: 25 rows.

**Tab: "Vendas" (Sales log — DASH-03):**
- Query `active_sales` with joins:
  ```
  active_sales
    .select('id, amount_cents, points_earned, created_at, customer_id, staff_id', { count: 'exact' })
    .eq('restaurant_id', restaurantId)
    .order('created_at', { ascending: false })
    .range(from, to)
  ```
  If `since` is not null: `.gte('created_at', since.toISOString())`

- Need customer name + card_number and manager email. Supabase PostgREST joins through views can be tricky. Instead:
  - Fetch sales rows first
  - Collect unique customer_ids and staff_ids
  - Batch fetch customers: `active_customers.select('id, name, card_number').in('id', customerIds)`
  - Batch fetch staff: `active_restaurant_staff.select('id, user_id').in('id', staffIds)` — BUT staff has no email column. Manager email is in auth.users which is not queryable via client SDK.
  - Workaround: Show staff_id info from restaurant_staff. Since the current schema doesn't store a display name on restaurant_staff, and auth.users is not accessible via PostgREST, use a pragmatic approach: query `active_restaurant_staff` joined with the role column. Display "Gerente" or "Proprietario" based on role. For POC this is sufficient — adding a `display_name` column to restaurant_staff is out of scope.
  - Actually, re-read the schema: restaurant_staff has `user_id` referencing auth.users(id). We can try the PostgREST join: `.select('..., restaurant_staff!inner(user_id, role)')` but we can't reach auth.users.email from there via PostgREST.
  - **Decision:** For POC, display the staff role ("Gerente"/"Proprietario") instead of email. This satisfies DASH-03 ("which manager registered") — the role identifies the person at POC scale (1-2 managers).

- Table columns: Data/Hora, Cliente, Cartao, Valor (R$), Pontos, Registrado por
- Format amount_cents as R$ X.XXX,XX
- Format created_at as DD/MM/YYYY HH:mm
- Build customer and staff lookup maps for display

**Tab: "Atividade" (Audit log — DASH-04):**
- Query `active_point_transactions`:
  ```
  active_point_transactions
    .select('id, customer_id, points_delta, balance_after, transaction_type, note, reference_id, created_at', { count: 'exact' })
    .eq('restaurant_id', restaurantId)
    .order('created_at', { ascending: false })
    .range(from, to)
  ```
  If `since` is not null: `.gte('created_at', since.toISOString())`

- Batch fetch customer names for display (same pattern as sales log)
- For transactions with `reference_id` and `transaction_type = 'earn'`, the reference_id points to a sale. Batch fetch those sales to get staff_id, then map to staff role.
- Table columns: Data/Hora, Cliente, Tipo, Pontos, Saldo, Gerente, Nota
- Transaction type display: earn → "Compra", redeem → "Resgate", adjustment → "Ajuste", expiry → "Expiração"
- Gerente column: show role from staff lookup if the transaction has a linked sale, otherwise "—"

**Tab navigation:**
- Two tab buttons at top: "Vendas" and "Atividade"
- Active tab: filled background. Inactive: outline.
- Tab click navigates to `?tab=vendas&page=1` or `?tab=atividade&page=1` (reset page on tab switch).
- Period selector: same 4 buttons (7d/30d/90d/all) — reuse pattern from analytics, or inline here.

**Pagination:**
- Same pattern as customer list: "Anterior" / "Proxima" links updating `page` searchParam while preserving `tab` and `period`.
- Show "X de Y registros" count.

All text in pt-BR.
  </action>
  <verify>
1. `npm run build` — compiles without errors
2. Navigate to /dashboard/owner/logs — sales tab shows with seed data sales
3. Click "Atividade" tab — shows point transactions with types
4. Period filter changes displayed data
5. Pagination works
6. Each log entry shows customer name, relevant details, and manager attribution
  </verify>
  <done>Owner can view sales log with customer, card number, value, points, and manager attribution. Owner can view audit log of all point transactions with type, customer, and manager info. Tabs separate the two views. Period filtering and pagination work.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Owner sidebar shows Analises, Clientes, Registros links
3. Analytics page: 4 stat cards + donut chart, period filtering works
4. Customers page: search, pagination, side panel with transaction history
5. Logs page: Vendas tab with sales data, Atividade tab with point transactions
6. All data is tenant-scoped (RLS enforced through authenticated client)
7. All UI text in pt-BR
</verification>

<success_criteria>
- Analytics overview shows total customers, points issued, sales count, revenue with period filtering
- Rank distribution donut chart renders correctly
- Customer list is searchable by name, phone, card number with pagination
- Customer detail side panel shows full info and transaction history
- Sales log shows all fields including manager attribution
- Audit log shows all point transactions with type labels
- Vendas and Atividade are separate tabs
- All metrics update with period selector
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-experience-analytics/04-03-SUMMARY.md`
</output>
