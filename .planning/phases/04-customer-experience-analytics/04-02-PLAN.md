---
phase: 04-customer-experience-analytics
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/lib/actions/customer.ts
  - src/app/[slug]/RegistrationModal.tsx
  - src/app/[slug]/page.tsx
autonomous: true
requirements:
  - CARD-01

must_haves:
  truths:
    - "A customer completes registration with only name and phone number"
    - "Post-registration shows a visual card preview with name, card number, and rank"
    - "Post-registration shows 'Adicionar a Apple Wallet' button on iOS devices"
    - "Non-iOS users see their card number without the Apple Wallet button"
    - "Phone number input uses (XX) XXXXX-XXXX mask"
    - "Registration completes in under 60 seconds from landing"
    - "Duplicate phone returns existing card instead of error"
  artifacts:
    - path: "src/lib/actions/customer.ts"
      provides: "registerCustomer Server Action"
      contains: "registerCustomer"
    - path: "src/app/[slug]/RegistrationModal.tsx"
      provides: "Registration modal with form and card preview"
      contains: "RegistrationModal"
  key_links:
    - from: "src/app/[slug]/RegistrationModal.tsx"
      to: "src/lib/actions/customer.ts"
      via: "useActionState with registerCustomer"
      pattern: "useActionState.*registerCustomer"
    - from: "src/lib/actions/customer.ts"
      to: "generate_next_card_number RPC"
      via: "supabase.rpc('generate_next_card_number')"
      pattern: "generate_next_card_number"
    - from: "src/lib/actions/customer.ts"
      to: "x-restaurant-id header"
      via: "headers() from next/headers"
      pattern: "headers.*x-restaurant-id"
---

<objective>
Build the customer registration flow: Server Action, registration modal with phone mask, card preview, and iOS-conditional Apple Wallet button.

Purpose: A customer must be able to register with just name and phone, see their card preview, and (on iOS) see the "Adicionar a Apple Wallet" button — all within 60 seconds of landing.

Output: Registration Server Action, client-side modal component, updated landing page.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-experience-analytics/04-RESEARCH.md
@.planning/phases/04-customer-experience-analytics/04-01-SUMMARY.md
@src/lib/supabase/service.ts
@src/lib/utils/card-number.ts
@src/app/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: registerCustomer Server Action + registration modal with card preview</name>
  <files>src/lib/actions/customer.ts, src/app/[slug]/RegistrationModal.tsx, src/app/[slug]/page.tsx</files>
  <action>
**`src/lib/actions/customer.ts`** — Server Action:
- `'use server'` directive at top
- Import `createServiceClient` from `@/lib/supabase/service` (NOT the auth client — customers are unauthenticated)
- Import `headers` from `next/headers`
- Import `z` from `zod`

- Define `RegisterState` type:
  ```typescript
  export type RegisterState =
    | { step: 'success'; cardNumber: string; customerName: string; rankName: string; isExisting: boolean }
    | { step: 'error'; message: string; fieldErrors?: { name?: string; phone?: string } }
    | undefined
  ```

- Validation schema:
  ```typescript
  const RegisterSchema = z.object({
    name: z.string().min(2, 'Nome deve ter ao menos 2 caracteres').max(100, 'Nome muito longo'),
    phone: z.string().regex(/^\d{10,11}$/, 'Telefone invalido'),
  })
  ```

- `registerCustomer(prevState: RegisterState, formData: FormData): Promise<RegisterState>`:
  1. Read `x-restaurant-id` from `await headers()` — CRITICAL: do NOT use a hidden form field. The middleware injects this header from the database-verified slug; it cannot be spoofed.
  2. If no restaurant_id header, return error.
  3. Extract `name` (trim), `phone` (strip non-digits from masked input).
  4. Validate with Zod. On failure, return field errors.
  5. Create service client: `createServiceClient()`
  6. Check duplicate phone: query `customers` where `restaurant_id` and `phone` match, `deleted_at IS NULL`. If found, return success with existing card number, name, rank name (fetch rank). Set `isExisting: true`.
  7. Generate card number: `supabase.rpc('generate_next_card_number', { p_restaurant_id: restaurantId })`
  8. Get bronze rank (lowest sort_order for this restaurant): query `active_ranks` ordered by `sort_order ASC`, limit 1.
  9. Insert customer: `{ restaurant_id, name, phone, card_number, points_balance: 0, visit_count: 0, total_spend: 0, current_rank_id: bronzeRank?.id }`
  10. Handle unique violation (error code '23505'): return existing customer's card.
  11. Return `{ step: 'success', cardNumber, customerName: name, rankName: bronzeRank?.name ?? 'Bronze', isExisting: false }`

**`src/app/[slug]/RegistrationModal.tsx`** — Client component:
- `'use client'` directive
- Import `useActionState` from `react`, `registerCustomer` from `@/lib/actions/customer`
- Props: `{ restaurantName: string; primaryColor: string; isOpen: boolean; onClose: () => void }`

- **Modal container:** Use `<dialog>` element. Control open/close via `ref.showModal()` / `ref.close()` in a `useEffect` keyed on `isOpen`. Style as centered overlay with backdrop.

- **Phone input:** Controlled input with custom formatting logic (~10 lines per research):
  ```typescript
  function formatPhone(raw: string): string {
    const digits = raw.replace(/\D/g, '').slice(0, 11)
    if (digits.length > 7) return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`
    if (digits.length > 2) return `(${digits.slice(0, 2)}) ${digits.slice(2)}`
    return digits
  }
  ```
  Store raw digits in a hidden `<input name="phone">` so the Server Action receives clean digits. Display formatted version in the visible input.

- **Form state:** `useActionState(registerCustomer, undefined)`
  - When `state?.step === 'error'`, show error message (and field errors if present)
  - When `state?.step === 'success'`, show card preview instead of form

- **Card preview (success state):**
  - Visual card that resembles what the customer will see in Apple Wallet
  - Card background: restaurant's `primaryColor`
  - Show: customer name, card number (e.g. "#0001-9"), rank name ("Bronze"), "0 pontos"
  - Below the card:
    - **iOS detection:** In a `useEffect`, check `navigator.userAgent` for iPhone/iPad. Store in state.
    - If iOS: show "Adicionar a Apple Wallet" button linking to `/api/pass/{cardNumber}` (the route handler will be built in a future phase when Apple certificates are ready — for now the button links there but the endpoint may not exist yet)
    - If not iOS: show text "Guarde seu numero: {cardNumber}" with no Apple Wallet button
  - A "Fechar" button to close the modal

- **Form (initial state):**
  - Name input: `<input name="name" placeholder="Seu nome" required>`
  - Phone input: masked as described above
  - Submit button: "Cadastrar" with primaryColor background
  - Pending state: use `useFormStatus` or check `isPending` from `useActionState` to disable button and show "Cadastrando..."

**`src/app/[slug]/page.tsx`** — Update:
- Import `RegistrationModal` component
- Add client-side wrapper for modal state: Create a small `'use client'` component `LandingPageClient` that:
  - Receives `restaurantName`, `primaryColor`, `restaurantId` as props
  - Manages `isModalOpen` state
  - Renders the CTA buttons (hero + footer) with `onClick={() => setIsModalOpen(true)}`
  - Renders `<RegistrationModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} ... />`
- The main page.tsx (Server Component) fetches branding and ranks, renders the static marketing sections, and embeds `<LandingPageClient>` for the interactive parts.

All text in pt-BR. No REVISIT branding.
  </action>
  <verify>
1. `npm run build` — compiles without errors
2. Visit `/{slug}`, click "Cadastre-se Gratis" — modal opens with name and phone fields
3. Enter name "Joao" and phone "(11) 99999-1234" — submit registers customer
4. Card preview appears with card number, name, rank "Bronze"
5. Submit same phone again — returns existing card (idempotent)
6. On desktop Chrome: no Apple Wallet button shown, card number displayed with "Guarde seu numero" text
  </verify>
  <done>Customer can register with name and phone on the landing page modal. Card preview shows after registration. Duplicate phone returns existing card. Phone input uses (XX) XXXXX-XXXX mask. Apple Wallet button shown only on iOS.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Full registration flow: land on /{slug} -> click CTA -> fill name + phone -> submit -> card preview appears
3. Registration under 60 seconds (form is 2 fields + 1 click)
4. Duplicate phone returns existing card without error
5. Phone mask formats correctly as user types
6. No REVISIT branding on any rendered element
7. Card preview shows name, card number, rank, points
</verification>

<success_criteria>
- registerCustomer Server Action uses service role client and reads restaurant_id from headers
- Registration modal opens from CTA button, shows form with phone mask
- Post-registration card preview displays card number, name, rank
- iOS detection controls Apple Wallet button visibility
- Duplicate phone registration is idempotent
- Entire flow completes in under 60 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-experience-analytics/04-02-SUMMARY.md`
</output>
