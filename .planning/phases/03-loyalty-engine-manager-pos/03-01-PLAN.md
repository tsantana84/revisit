---
phase: 03-loyalty-engine-manager-pos
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0007_loyalty_engine.sql
  - supabase/seed.sql
  - src/lib/utils/card-number.ts
  - src/lib/utils/card-number.test.ts
  - vitest.config.ts
autonomous: true
requirements: [CARD-03, RANK-02, PTS-05]

must_haves:
  truths:
    - "generateCardNumber(1) returns '#0001-9' and validateCardNumber('#0001-9') returns true"
    - "validateCardNumber rejects letters in check digit position, wrong digits, and malformed strings"
    - "register_sale() RPC function exists in PostgreSQL and performs atomic sale + points + rank promotion"
    - "register_redemption() RPC function exists in PostgreSQL for reward redemptions"
    - "ranks table has discount_pct column for progressive discount model"
    - "Seed data uses valid Luhn check digits instead of letter suffixes"
    - "Seed data populates min_visits and multiplier on ranks with default values"
  artifacts:
    - path: "supabase/migrations/0007_loyalty_engine.sql"
      provides: "register_sale RPC, register_redemption RPC, discount_pct column"
      contains: "CREATE OR REPLACE FUNCTION public.register_sale"
    - path: "src/lib/utils/card-number.ts"
      provides: "generateCardNumber, validateCardNumber, extractSequence"
      exports: ["generateCardNumber", "validateCardNumber", "extractSequence"]
    - path: "src/lib/utils/card-number.test.ts"
      provides: "Unit tests for Luhn check digit generation and validation"
      contains: "describe"
    - path: "vitest.config.ts"
      provides: "Extended test include for src unit tests"
      contains: "src/**/*.test.ts"
  key_links:
    - from: "src/lib/utils/card-number.ts"
      to: "supabase/seed.sql"
      via: "Card numbers in seed must pass validateCardNumber()"
      pattern: "#\\d{4}-\\d"
---

<objective>
Create the database migration for the loyalty engine (register_sale and register_redemption RPCs, discount_pct column), the card number utility with Luhn check-digit validation, update seed data to use valid card numbers, and extend vitest config for src-level unit tests.

Purpose: This is the foundation layer for Phase 3 — all subsequent plans depend on the RPC functions existing in PostgreSQL and the card number utility being importable.
Output: Migration file, card-number utility with tests, updated seed data.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-loyalty-engine-manager-pos/03-RESEARCH.md
@supabase/migrations/0001_schema.sql
@supabase/migrations/0005_branding.sql
@supabase/seed.sql
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Card number utility with Luhn check-digit and unit tests</name>
  <files>src/lib/utils/card-number.ts, src/lib/utils/card-number.test.ts, vitest.config.ts</files>
  <action>
Create `src/lib/utils/card-number.ts` with three exported functions:

1. `computeLuhnDigit(digits: string): string` — internal helper. Iterates right-to-left over the digit string, doubles every second digit (from right, 0-indexed), subtracts 9 if >9, sums all digits, returns `String((10 - (sum % 10)) % 10)`.

2. `generateCardNumber(sequence: number): string` — validates sequence is 1-9999, pads to 4 digits, computes Luhn check digit, returns `#XXXX-D` format.

3. `validateCardNumber(input: string): boolean` — regex match `^#(\d{4})-(\d)$`, extract XXXX and D, verify `computeLuhnDigit(XXXX) === D`.

4. `extractSequence(cardNumber: string): number` — parses the 4-digit portion as integer. Call only after validateCardNumber returns true.

Create `src/lib/utils/card-number.test.ts` with vitest tests:
- `generateCardNumber(1)` returns `'#0001-9'`
- `generateCardNumber(2)` returns `'#0002-8'`
- `generateCardNumber(5)` returns `'#0005-5'`
- `generateCardNumber(9999)` returns a valid card number (validateCardNumber passes)
- `validateCardNumber('#0001-9')` returns true
- `validateCardNumber('#0001-0')` returns false (wrong check digit)
- `validateCardNumber('#0001-A')` returns false (letter suffix)
- `validateCardNumber('0001-9')` returns false (missing #)
- `validateCardNumber('')` returns false
- `extractSequence('#0001-9')` returns 1
- `generateCardNumber(0)` throws
- `generateCardNumber(10000)` throws

Update `vitest.config.ts`: add `'src/**/*.test.ts'` to the `include` array alongside the existing `'supabase/tests/**/*.test.ts'` entry.
  </action>
  <verify>Run `npx vitest run src/lib/utils/card-number.test.ts` — all tests pass.</verify>
  <done>Card number utility generates and validates #XXXX-D format with correct Luhn check digits. All 12+ unit tests pass. Vitest config includes src tests.</done>
</task>

<task type="auto">
  <name>Task 2: Loyalty engine migration and seed data update</name>
  <files>supabase/migrations/0007_loyalty_engine.sql, supabase/seed.sql</files>
  <action>
Create `supabase/migrations/0007_loyalty_engine.sql` with:

1. **Add `discount_pct` column to ranks:**
   ```sql
   ALTER TABLE public.ranks
     ADD COLUMN IF NOT EXISTS discount_pct NUMERIC(4,1) NOT NULL DEFAULT 0;
   ```

2. **Create `register_sale()` function** — SECURITY DEFINER, SET search_path = ''. Parameters: `p_card_number TEXT, p_amount_cents INTEGER, p_staff_id UUID`. Returns JSONB. The function must:
   - Get restaurant_id from `(SELECT public.get_restaurant_id())`
   - Validate card format with regex `'^#\d{4}-\d$'`
   - Look up customer by card_number + restaurant_id + deleted_at IS NULL
   - Get earn_rate from restaurants table
   - Get multiplier from current rank (fallback 1.0 if NULL)
   - Calculate points: `ROUND(p_amount_cents::NUMERIC / 100 * v_earn_rate * v_multiplier)::INTEGER`
   - Compute new balance and visit count
   - Determine new rank: highest rank where `min_visits <= new_visit_count`, ordered by min_visits DESC, LIMIT 1
   - Check rank promotion: `v_new_rank_id IS DISTINCT FROM v_customer.current_rank_id`
   - INSERT into sales, INSERT into point_transactions (type='earn', reference_id=sale_id), UPDATE customers (balance, visit_count, rank)
   - Return JSONB with success, sale_id, points_earned, new_balance, new_visit_count, rank_promoted, new_rank_name, customer_name
   - Return JSONB error objects for: not_authenticated, invalid_card_format, customer_not_found
   - GRANT EXECUTE to authenticated, REVOKE from anon

3. **Create `register_redemption()` function** — SECURITY DEFINER, SET search_path = ''. Parameters: `p_card_number TEXT, p_reward_config_id UUID`. Returns JSONB. The function must:
   - Get restaurant_id, look up customer, look up reward_config (active, not deleted)
   - Check points_balance >= points_required (for cashback/free_product models)
   - INSERT into reward_redemptions, INSERT into point_transactions (type='redeem', negative delta), UPDATE customer balance
   - Return JSONB with success, points_spent, new_balance, reward_name
   - Error cases: not_authenticated, customer_not_found, reward_not_found, insufficient_points
   - GRANT EXECUTE to authenticated, REVOKE from anon

Use the exact code from 03-RESEARCH.md Pattern 3 and Code Examples sections as the implementation reference. Use fully-qualified table names (public.customers, public.ranks, etc.) in both functions.

**Update `supabase/seed.sql`:**
- Change customer card numbers to valid Luhn format:
  - Ana: `#0001-9` (was `#0001-A`)
  - Carlos: `#0002-8` (was `#0001-B`)
  - Julia: `#0003-7` (was `#0001-C`)
  - Pedro: `#0004-6` (was `#0001-D`)
  - Mariana: `#0005-5` (was `#0001-E`)
- Update ranks INSERT to include `min_visits`, `multiplier`, and `discount_pct`:
  - Bronze: min_visits=0, multiplier=1.0, discount_pct=0
  - Prata: min_visits=5, multiplier=1.5, discount_pct=5
  - Gold: min_visits=15, multiplier=2.0, discount_pct=10
  - VIP: min_visits=30, multiplier=3.0, discount_pct=15
- The seed INSERT for ranks must include these columns in the column list since the table now has them (added by 0005_branding.sql and 0007_loyalty_engine.sql).
  </action>
  <verify>Run `npx supabase db reset` — migration applies without errors, seed loads. Run `npx supabase db lint` if available, or manually verify with `psql` that `register_sale` function exists: `SELECT proname FROM pg_proc WHERE proname = 'register_sale';`</verify>
  <done>Migration 0007 creates register_sale and register_redemption RPCs with SECURITY DEFINER. Seed data uses valid Luhn card numbers and populates min_visits, multiplier, discount_pct on ranks.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/lib/utils/card-number.test.ts` passes all tests
2. `npx supabase db reset` completes without errors
3. Card numbers in seed data pass `validateCardNumber()` check
4. `register_sale` and `register_redemption` functions exist in pg_proc
</verification>

<success_criteria>
- Card number utility correctly generates and validates #XXXX-D format with Luhn algorithm
- All unit tests pass
- RPC functions exist and are callable
- Seed data is consistent with the new card number format
- Vitest config covers both src and supabase test directories
</success_criteria>

<output>
After completion, create `.planning/phases/03-loyalty-engine-manager-pos/03-01-SUMMARY.md`
</output>
