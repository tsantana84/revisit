---
phase: 03-loyalty-engine-manager-pos
plan: 04
type: execute
wave: 3
depends_on: [03-02, 03-03]
files_modified:
  - src/app/dashboard/manager/page.tsx
  - src/app/dashboard/manager/layout.tsx
autonomous: false
requirements: [MGR-01, MGR-02, MGR-03, MGR-04, MGR-05, MGR-06, MGR-07]

must_haves:
  truths:
    - "Manager can type a card number in #XXXX-D format and the system validates the check digit before lookup"
    - "After entering card number and sale value, manager sees 'Isso creditara X pontos para [Nome]. Confirmar?'"
    - "After confirmation, points are credited and success message shows with rank promotion notice if applicable"
    - "Manager can see and confirm reward redemption when available"
    - "Manager panel shows ONLY card lookup, sale registration, and reward redemption — no analytics, customer list, config, or navigation to other sections"
    - "Invalid card numbers are rejected with immediate feedback before any DB query"
  artifacts:
    - path: "src/app/dashboard/manager/page.tsx"
      provides: "Manager POS page with card lookup, sale confirmation, reward display"
      contains: "useActionState"
      min_lines: 100
    - path: "src/app/dashboard/manager/layout.tsx"
      provides: "Stripped-down manager layout with no navigation to other sections"
      contains: "Painel"
  key_links:
    - from: "src/app/dashboard/manager/page.tsx"
      to: "src/lib/actions/pos.ts"
      via: "import lookupCustomer, registerSale for useActionState"
      pattern: "import.*lookupCustomer.*registerSale"
    - from: "src/app/dashboard/manager/page.tsx"
      to: "src/lib/actions/rewards.ts"
      via: "import registerRedemption for reward confirmation"
      pattern: "import.*registerRedemption"
---

<objective>
Build the Manager POS page with the complete transaction flow: card lookup with check-digit validation, two-step sale confirmation with points preview, reward availability display, and reward redemption confirmation. The page must be a single-function UI with no access to analytics, customer lists, or configuration.

Purpose: This is the core POS interface that managers use to register sales. The two-step confirmation prevents errors. The stripped-down UI ensures managers stay focused.
Output: Fully functional manager POS page.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-loyalty-engine-manager-pos/03-RESEARCH.md
@.planning/phases/03-loyalty-engine-manager-pos/03-01-SUMMARY.md
@.planning/phases/03-loyalty-engine-manager-pos/03-02-SUMMARY.md
@.planning/phases/03-loyalty-engine-manager-pos/03-03-SUMMARY.md
@src/app/dashboard/manager/page.tsx
@src/app/dashboard/manager/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Manager POS page — card lookup, sale confirmation, reward flow</name>
  <files>src/app/dashboard/manager/page.tsx</files>
  <action>
Replace the placeholder manager page with a full POS interface. This is a `'use client'` component.

**Imports:**
- `useActionState` from `react`
- `lookupCustomer`, `registerSale` from `@/lib/actions/pos`
- `registerRedemption` from `@/lib/actions/rewards`
- `validateCardNumber` from `@/lib/utils/card-number` (for client-side instant feedback)

**State management:** Use two separate `useActionState` hooks:
1. `[lookupState, lookupAction, lookupPending]` bound to `lookupCustomer`
2. `[saleState, saleAction, salePending]` bound to `registerSale`
3. `[redemptionState, redemptionAction, redemptionPending]` bound to `registerRedemption`

Plus local state:
- `cardInput` string state for controlled input with format hint
- `showReward` boolean to toggle reward section visibility

**UI Flow — Three phases rendered conditionally:**

**Phase 1: Card Lookup Form** (shown when no lookupState, or lookupState.step === 'error', or after reset)
- Title: "Registrar Venda"
- Card number input: text, placeholder "#0000-0", with client-side validation feedback (shows error inline if `cardInput` is non-empty and `!validateCardNumber(cardInput)`)
- Sale value input: number, step="0.01", min="0.01", placeholder "0,00", label "Valor da venda (R$)"
- Submit button: "Buscar Cliente", disabled while `lookupPending`
- Error message display from `lookupState.step === 'error'`

**Phase 2: Sale Confirmation** (shown when lookupState.step === 'preview' AND !saleState?.step === 'success')
- Customer info card: Name (large), Current rank (badge), Points balance
- Confirmation message: "Isso creditara {pointsPreview} pontos para {customerName}. Confirmar?" (use proper Portuguese accents)
- Hidden inputs: card_number, amount_cents, staff_id (from lookupState)
- "Confirmar Venda" button (primary, prominent), disabled while `salePending`
- "Cancelar" button that resets state (set a local resetKey state or use window.location.reload for simplicity — actually, just set a `resetTrigger` state that conditionally shows Phase 1)
- Error from saleState if step === 'error'

**Phase 3: Success** (shown when saleState.step === 'success')
- Success icon/message: "Venda registrada com sucesso!"
- Points earned: "{pointsEarned} pontos creditados para {customerName}"
- New balance: "Saldo atual: {newBalance} pontos"
- If `rankPromoted`: highlighted promotion notice "Cliente promovido para {newRankName}!"
- "Nova Venda" button that resets all state to Phase 1
- Reward section (if applicable): show available reward info and "Resgatar Recompensa" button if a reward is available

**Reward display:**
After a successful sale, call `checkRewardAvailability` to show if the customer has a reward available. Since checkRewardAvailability is a server function, and this is a client component, the approach is:
- Include reward info in the lookupCustomer response (add it there), OR
- Render a separate section that uses a form action to check reward

Simpler approach: In `lookupCustomer` (pos.ts), also fetch reward availability and include it in the preview state. Add `rewardInfo` to the LookupState preview type. This way the manager sees reward info alongside the sale confirmation. If there's a reward, show it. After the sale, if `saleState.step === 'success'`, re-display reward info for potential redemption.

Actually, to avoid modifying pos.ts (already done in Plan 02), handle reward display as a separate concern:
- After sale success, show a "Verificar Recompensa" button that submits a form to a `checkReward` server action
- OR, include reward info inline in the POS page by fetching it on sale success

Best approach for POC: Add reward info to the success phase. Create a small wrapper component `RewardSection` that uses `useActionState` with a check action. The action reads the customer's reward availability and returns the data. If a reward is available, show a "Resgatar" button that calls `registerRedemption`.

**Styling:** Use inline styles matching the existing codebase pattern (see layout.tsx). Clean, functional design:
- White cards with subtle shadows for each section
- Clear visual hierarchy (large customer name, colored rank badge)
- Generous padding and spacing
- Primary action buttons in a distinctive color (#2563eb blue or similar)
- Error messages in red (#dc2626)
- Success messages in green (#16a34a)
- The overall feel: a simple POS terminal, not a complex dashboard

**MGR-07 compliance:** The page renders ONLY the card lookup form, sale confirmation, and reward redemption. There are NO links, navigation items, or routes to analytics, customer lists, settings, or any other section. The layout.tsx sidebar already has minimal nav — verify it only shows "Painel" and "Sair" (no additional links).
  </action>
  <verify>Run `npm run dev`. Navigate to /dashboard/manager (as a manager user). Verify: card input shows, typing an invalid card number shows inline validation error, entering a valid card number and amount shows the confirmation screen with points preview.</verify>
  <done>Manager POS page renders the full card lookup -> sale confirmation -> success flow with reward display. Only card lookup and sale registration UI is accessible — no analytics, customer list, or configuration navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Strip manager layout navigation to enforce single-function UI</name>
  <files>src/app/dashboard/manager/layout.tsx</files>
  <action>
Read the existing manager layout.tsx. It currently has a sidebar with "Painel" link and "Sair" button.

Verify it does NOT have links to:
- /dashboard/owner (or any owner routes)
- /dashboard/manager/analytics or similar
- /dashboard/manager/customers or similar
- /dashboard/manager/settings or similar

If any such links exist, remove them. The nav should contain ONLY:
1. The brand name (or restaurant name if available)
2. A single "Painel" link to /dashboard/manager
3. The "Sair" (logout) button

If the layout already meets this requirement (which it appears to from the current code), leave it as-is. Only modify if there are extra navigation elements.

The key MGR-07 requirement: "Manager cannot access analytics, customer lists, configurations, or any other section." The layout enforces this by having no navigation to those routes. The middleware already blocks manager role from /dashboard/owner routes. This task verifies and locks down the layout.
  </action>
  <verify>Inspect the rendered manager layout in the browser — verify only "Painel" and "Sair" appear in the sidebar. No other navigation links are visible.</verify>
  <done>Manager layout contains only the POS panel link and logout. No navigation to analytics, customer lists, or settings exists.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Manager POS flow end-to-end</name>
  <files>src/app/dashboard/manager/page.tsx</files>
  <action>
Human verification of the complete Manager POS flow built in Tasks 1 and 2.

What was built: Complete Manager POS flow with card lookup and check-digit validation, two-step sale confirmation with points preview, success screen with rank promotion notice, reward display, and manager layout stripped to single-function UI.

Steps to verify:
1. Start dev server: `npm run dev` and `npx supabase start` (if not running)
2. Reset database: `npx supabase db reset` (loads seed data with valid card numbers)
3. Log in as a manager user (create one via owner panel if needed)
4. At /dashboard/manager, verify:
   a. Card number input is visible with "Registrar Venda" title
   b. Type "#0001-0" (invalid check digit) — inline validation error should appear
   c. Type "#0001-9" (valid, Ana Souza in seed data) and enter R$50.00
   d. Click "Buscar Cliente" — should see confirmation: "Isso creditara X pontos para Ana Souza"
   e. Click "Confirmar Venda" — should see success with points credited
   f. If Ana was promoted (unlikely at 32 visits), rank promotion notice should appear
   g. Click "Nova Venda" — should return to card lookup
5. Verify sidebar has ONLY "Painel" and "Sair" — no other links
6. Try navigating to /dashboard/owner — should be blocked by middleware
  </action>
  <verify>Human visually confirms all verification steps pass</verify>
  <done>Manager POS flow works end-to-end: lookup, preview, confirm, success. Layout is single-function. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
1. Manager can look up customer by card number with check-digit validation
2. Two-step confirmation shows points preview before committing
3. Sale registration credits points atomically via RPC
4. Rank promotion is displayed when it occurs
5. Manager layout has no navigation to analytics, customer list, or settings
6. Invalid card numbers are rejected before any database query
</verification>

<success_criteria>
- Full card lookup -> preview -> confirm -> success flow works end-to-end
- Points calculation matches: sale_value * earn_rate * rank_multiplier
- Rank promotion is detected and displayed
- Manager panel is a single-function UI per MGR-07
- All UI text is in pt-BR
</success_criteria>

<output>
After completion, create `.planning/phases/03-loyalty-engine-manager-pos/03-04-SUMMARY.md`
</output>
