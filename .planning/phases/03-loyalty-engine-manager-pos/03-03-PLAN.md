---
phase: 03-loyalty-engine-manager-pos
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/lib/actions/rewards.ts
  - src/app/dashboard/owner/settings/RanksForm.tsx
  - src/lib/actions/restaurant.ts
autonomous: true
requirements: [RWRD-01, RWRD-02, RWRD-03, RWRD-04, RWRD-05, RANK-01]

must_haves:
  truths:
    - "checkRewardAvailability returns the correct reward info based on restaurant's reward_type"
    - "Cashback model shows available R$ credit calculated from points_balance / earn_rate"
    - "Free product model shows available reward when points_balance >= points_required"
    - "Progressive discount model shows discount percentage from customer's current rank"
    - "registerRedemption calls register_redemption RPC for cashback and free_product models"
    - "Progressive discount redemption records audit row without deducting points"
    - "RanksForm includes discount_pct field per rank row"
  artifacts:
    - path: "src/lib/actions/rewards.ts"
      provides: "checkRewardAvailability, registerRedemption Server Actions"
      exports: ["checkRewardAvailability", "registerRedemption", "RewardState", "RedemptionState"]
      min_lines: 80
    - path: "src/app/dashboard/owner/settings/RanksForm.tsx"
      provides: "Updated ranks form with discount_pct input"
      contains: "discount_pct"
    - path: "src/lib/actions/restaurant.ts"
      provides: "Updated RankSchema with discount_pct validation"
      contains: "discount_pct"
  key_links:
    - from: "src/lib/actions/rewards.ts"
      to: "supabase RPC register_redemption"
      via: "supabase.rpc('register_redemption', { p_card_number, p_reward_config_id })"
      pattern: "rpc.*register_redemption"
    - from: "src/lib/actions/rewards.ts"
      to: "active_restaurants view"
      via: "reads reward_type to branch logic"
      pattern: "reward_type"
---

<objective>
Create the reward system Server Actions (check availability and register redemption) that branch on the restaurant's reward_type (cashback, free_product, progressive_discount). Also update the RanksForm to include the discount_pct field needed by the progressive discount model.

Purpose: The reward system completes the transaction flow — after a sale credits points, the manager can check if a reward is available and confirm redemption.
Output: `src/lib/actions/rewards.ts` with reward logic, updated RanksForm with discount_pct.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-loyalty-engine-manager-pos/03-RESEARCH.md
@.planning/phases/03-loyalty-engine-manager-pos/03-01-SUMMARY.md
@src/lib/actions/restaurant.ts
@src/app/dashboard/owner/settings/RanksForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reward Server Actions — checkRewardAvailability and registerRedemption</name>
  <files>src/lib/actions/rewards.ts</files>
  <action>
Create `src/lib/actions/rewards.ts` with `'use server'` directive.

**Types:**

```typescript
export type RewardInfo =
  | { type: 'cashback'; availableCredit: number; pointsBalance: number; earnRate: number }
  | { type: 'free_product'; available: boolean; rewardName: string; rewardId: string; pointsRequired: number; pointsBalance: number }
  | { type: 'progressive_discount'; discountPct: number; rankName: string }
  | { type: 'none' }

export type RedemptionState =
  | { step: 'success'; message: string; newBalance: number }
  | { step: 'error'; message: string }
  | undefined
```

**checkRewardAvailability(cardNumber: string, restaurantId: string, supabase: SupabaseClient): Promise<RewardInfo>:**
This is a helper function (not a Server Action — it's called from pos.ts or the POS page). It does NOT use `'use server'`.

Actually, make this a proper exported async function within the `'use server'` module but called internally from the POS page's server component or from lookupCustomer. It needs:

1. Get the restaurant's `reward_type` and `earn_rate` from `active_restaurants`
2. Get the customer by card_number from `active_customers` with their `points_balance`, `current_rank_id`
3. Branch on `reward_type`:

   **cashback:** Return `{ type: 'cashback', availableCredit: Math.floor(customer.points_balance / earnRate), pointsBalance: customer.points_balance, earnRate }`

   **free_product:** Query `active_reward_configs` where `restaurant_id = restaurantId AND is_active = true`, ordered by `points_required ASC`. Find first where `customer.points_balance >= points_required`. If found: `{ type: 'free_product', available: true, rewardName, rewardId, pointsRequired, pointsBalance }`. If none: `{ type: 'free_product', available: false, rewardName: '', rewardId: '', pointsRequired: 0, pointsBalance }`

   **progressive_discount:** Query the customer's current rank from `active_ranks` to get `discount_pct` and `name`. Return `{ type: 'progressive_discount', discountPct: rank.discount_pct ?? 0, rankName: rank.name ?? 'Sem nivel' }`

   **default:** `{ type: 'none' }`

**registerRedemption(prevState: RedemptionState, formData: FormData): Promise<RedemptionState>:**
Server Action for useActionState.

1. Extract `card_number`, `reward_config_id`, `reward_type` from formData
2. Call `getAuthenticatedManager()` (import the same helper pattern — or duplicate it since it's in pos.ts; better: extract to a shared file `src/lib/actions/auth-helpers.ts`, BUT to avoid touching pos.ts in this plan, just duplicate the helper inline in rewards.ts — same pattern, same RevisitClaims interface)
3. If `reward_type === 'progressive_discount'`:
   - No points deduction. Insert a record into `reward_redemptions` directly via supabase client (not RPC needed for this simple case since it's a single insert)
   - Actually, use the register_redemption RPC for consistency. The RPC checks `points_balance >= points_required`. For progressive discount, set `p_reward_config_id` to a special marker OR handle it differently.
   - Better approach: For progressive discount, insert directly into `reward_redemptions` with `points_spent = 0` and insert a point_transaction with `points_delta = 0, transaction_type = 'redeem'` for audit. Do this via individual supabase calls (acceptable since it's two inserts with no balance change — no atomicity risk).
4. For cashback and free_product: call `supabase.rpc('register_redemption', { p_card_number: cardNumber, p_reward_config_id: rewardConfigId })`
5. Map errors to Portuguese messages, return success state with new balance.
  </action>
  <verify>`npx tsc --noEmit` passes. The file exports checkRewardAvailability and registerRedemption.</verify>
  <done>Reward actions correctly branch on reward_type, check availability, and handle redemption for all three models. Progressive discount records audit row without point deduction.</done>
</task>

<task type="auto">
  <name>Task 2: Add discount_pct field to RanksForm and RankSchema</name>
  <files>src/app/dashboard/owner/settings/RanksForm.tsx, src/lib/actions/restaurant.ts</files>
  <action>
Read the existing `RanksForm.tsx` and add a `discount_pct` field to each rank row.

1. Add `discount_pct` to the rank row state type (should already have name, min_visits, multiplier — add discount_pct as number, default 0).
2. Add an input field labeled "Desconto (%)" in each rank row, type="number", step="0.1", min="0", max="100".
3. Include `discount_pct` in the JSON serialization to `ranks_json` hidden field.
4. When loading existing ranks from the server (the page.tsx passes initial data), include `discount_pct` in the data shape.

Also update the `RankSchema` in `src/lib/actions/restaurant.ts`:
- Add `discount_pct: z.number().min(0).max(100).default(0)` to the RankSchema
- Include `discount_pct` in the `ranksToInsert` map inside `updateRanks()`
  </action>
  <verify>`npx tsc --noEmit` passes. Grep `src/app/dashboard/owner/settings/RanksForm.tsx` and `src/lib/actions/restaurant.ts` for `discount_pct` — both files must contain it.</verify>
  <done>RanksForm shows discount percentage input per rank. updateRanks Server Action validates and persists discount_pct. Existing ranks without discount_pct default to 0.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. checkRewardAvailability returns correct shape for each reward_type
3. registerRedemption handles all three models
4. RanksForm includes discount_pct field and it persists on save
</verification>

<success_criteria>
- Reward availability check works for cashback (R$ credit), free product (threshold check), and progressive discount (rank %)
- Redemption flow handles point deduction for cashback/free_product and audit-only for progressive discount
- RanksForm has discount_pct field that saves to database
</success_criteria>

<output>
After completion, create `.planning/phases/03-loyalty-engine-manager-pos/03-03-SUMMARY.md`
</output>
