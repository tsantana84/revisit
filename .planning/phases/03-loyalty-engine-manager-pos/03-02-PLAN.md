---
phase: 03-loyalty-engine-manager-pos
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/lib/actions/pos.ts
autonomous: true
requirements: [PTS-01, PTS-02, PTS-03, RANK-03, RANK-04, RANK-05]

must_haves:
  truths:
    - "lookupCustomer returns customer name, rank, points balance, and a points preview without writing to DB"
    - "registerSale calls register_sale RPC and returns success with points earned, rank promotion status"
    - "Points preview matches formula: Math.round(amountCents / 100 * earnRate * multiplier)"
    - "Manager auth is verified via JWT claims before any DB operation"
    - "Staff ID is resolved from restaurant_staff table, not assumed from JWT sub"
  artifacts:
    - path: "src/lib/actions/pos.ts"
      provides: "getAuthenticatedManager, lookupCustomer, registerSale Server Actions"
      exports: ["lookupCustomer", "registerSale", "LookupState", "SaleState"]
      min_lines: 100
  key_links:
    - from: "src/lib/actions/pos.ts"
      to: "supabase RPC register_sale"
      via: "supabase.rpc('register_sale', { p_card_number, p_amount_cents, p_staff_id })"
      pattern: "rpc.*register_sale"
    - from: "src/lib/actions/pos.ts"
      to: "src/lib/utils/card-number.ts"
      via: "import validateCardNumber for server-side format validation"
      pattern: "validateCardNumber"
    - from: "src/lib/actions/pos.ts"
      to: "active_customers view"
      via: "supabase.from('active_customers').select() for lookup"
      pattern: "from.*active_customers"
---

<objective>
Create the POS Server Actions: getAuthenticatedManager helper, lookupCustomer (read-only preview), and registerSale (calls register_sale RPC). These are the backend functions the manager POS page will use.

Purpose: Separates business logic from UI. The lookupCustomer action provides a preview (no write), and registerSale commits the transaction atomically via the RPC created in Plan 01.
Output: `src/lib/actions/pos.ts` with typed Server Actions.
</objective>

<execution_context>
@/Users/thiagosantana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thiagosantana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-loyalty-engine-manager-pos/03-RESEARCH.md
@.planning/phases/03-loyalty-engine-manager-pos/03-01-SUMMARY.md
@src/lib/actions/restaurant.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: POS Server Actions — lookupCustomer and registerSale</name>
  <files>src/lib/actions/pos.ts</files>
  <action>
Create `src/lib/actions/pos.ts` with `'use server'` directive. Follow the exact patterns from `src/lib/actions/restaurant.ts` (getAuthenticatedOwner pattern, Zod validation, jwt-decode).

**Types (discriminated union):**

```typescript
export type LookupState =
  | { step: 'preview'; customerName: string; currentRank: string; pointsBalance: number;
      pointsPreview: number; cardNumber: string; amountCents: number; staffId: string }
  | { step: 'error'; message: string }
  | undefined

export type SaleState =
  | { step: 'success'; pointsEarned: number; newBalance: number; customerName: string;
      rankPromoted: boolean; newRankName: string }
  | { step: 'error'; message: string }
  | undefined
```

**getAuthenticatedManager()** — internal helper (not exported). Mirrors `getAuthenticatedOwner()` from restaurant.ts but:
- Accepts BOTH `owner` and `manager` roles (owners can also use POS for POC flexibility)
- Looks up `restaurant_staff.id` via `active_restaurant_staff` view filtered by `user_id`
- Returns `{ supabase, restaurantId, staffId, userId }` or `{ error: string }`
- Uses the same `RevisitClaims` interface shape as restaurant.ts

**lookupCustomer(prevState: LookupState, formData: FormData): Promise<LookupState>:**
1. Extract `card_number` (trim) and `amount` from formData
2. Validate card format with `validateCardNumber()` from `@/lib/utils/card-number` — return error if invalid
3. Validate amount: `parseFloat`, must be > 0, max 99999.99 — return error if invalid
4. Call `getAuthenticatedManager()` — return error if auth fails
5. Convert amount to cents: `Math.round(parseFloat(amount) * 100)`
6. Query `active_customers` with select: `id, name, points_balance, visit_count, current_rank_id` — filter by `card_number` and use `.single()`
7. If not found, return `{ step: 'error', message: 'Cartao nao encontrado' }` (use proper Portuguese accents)
8. Query `active_ranks` for the customer's `current_rank_id` to get `name` and `multiplier`
9. Query `active_restaurants` for `earn_rate` by `restaurantId`
10. Calculate preview: `Math.round(amountCents / 100 * earnRate * multiplier)` — fallback multiplier=1 if no rank
11. Return `{ step: 'preview', customerName, currentRank, pointsBalance, pointsPreview, cardNumber, amountCents, staffId }`

**registerSale(prevState: SaleState, formData: FormData): Promise<SaleState>:**
1. Extract `card_number`, `amount_cents`, `staff_id` from formData (these are hidden fields populated from the preview state)
2. Validate with Zod: card_number (refine with validateCardNumber), amount_cents (coerce int, min 1), staff_id (uuid)
3. Call `getAuthenticatedManager()` for auth check
4. Call `supabase.rpc('register_sale', { p_card_number, p_amount_cents, p_staff_id })`
5. Handle PostgREST error: return `{ step: 'error', message: 'Erro interno' }`
6. Handle RPC application errors: map `data.error` strings to Portuguese messages:
   - `not_authenticated` -> `'Sessao expirada. Faca login novamente.'`
   - `invalid_card_format` -> `'Formato de cartao invalido.'`
   - `customer_not_found` -> `'Cartao nao encontrado.'`
   - Default -> `'Erro desconhecido'`
7. On success: return `{ step: 'success', pointsEarned: data.points_earned, newBalance: data.new_balance, customerName: data.customer_name, rankPromoted: data.rank_promoted, newRankName: data.new_rank_name ?? '' }`

Use proper pt-BR characters (accents) in all user-facing strings. Do NOT use the Zod `error` shorthand for refine — use `{ message: '...' }` syntax for refine validators.
  </action>
  <verify>TypeScript compilation: `npx tsc --noEmit` passes (or at least `src/lib/actions/pos.ts` has no type errors). Verify the file exports the correct types and functions.</verify>
  <done>pos.ts exports lookupCustomer and registerSale Server Actions with proper auth, validation, points calculation, and RPC integration. Both use discriminated union state types compatible with useActionState.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for pos.ts
2. lookupCustomer does NOT write to database (read-only preview)
3. registerSale calls RPC atomically (not sequential DB calls)
4. Both actions validate card number server-side before DB query
5. Error messages are in Portuguese
</verification>

<success_criteria>
- lookupCustomer returns preview with calculated points without any DB write
- registerSale delegates to register_sale RPC for atomic commit
- Auth check works for both manager and owner roles
- Staff ID resolved from active_restaurant_staff, not assumed
</success_criteria>

<output>
After completion, create `.planning/phases/03-loyalty-engine-manager-pos/03-02-SUMMARY.md`
</output>
