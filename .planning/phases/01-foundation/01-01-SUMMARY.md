---
phase: 01-foundation
plan: 01
subsystem: database
tags: [postgres, supabase, rls, jwt, multi-tenant, soft-delete, migrations]

# Dependency graph
requires: []
provides:
  - PostgreSQL schema with 8 tables (restaurants, restaurant_staff, customers,
    ranks, reward_configs, point_transactions, reward_redemptions, sales)
  - RLS tenant isolation policies using get_restaurant_id() JWT helper
  - Custom Access Token Hook that injects restaurant_id and app_role into JWT
  - Active-record views filtering soft-deleted rows for all 8 tables
  - Demo restaurant seed data (5 customers, 4 ranks, 2 rewards, 6 transactions)
affects: [02-auth, 03-manager-panel, 04-wallet, 05-owner-portal]

# Tech tracking
tech-stack:
  added: [supabase-cli-v2.75.0]
  patterns:
    - "RLS via SECURITY DEFINER helper with (SELECT ...) wrapper for query plan caching"
    - "Soft-delete via views (not RLS) to avoid UPDATE re-validation conflict"
    - "Custom Access Token Hook for JWT claim injection at token issuance"
    - "restaurant_id on every table for explicit, consistent tenant isolation"

key-files:
  created:
    - supabase/config.toml
    - supabase/migrations/0001_schema.sql
    - supabase/migrations/0002_rls.sql
    - supabase/migrations/0003_views.sql
    - supabase/seed.sql
  modified: []

key-decisions:
  - "Soft-delete via active_* views (not RLS) — RLS UPDATE re-validation conflict would block setting deleted_at"
  - "SECURITY DEFINER get_restaurant_id() with (SELECT ...) wrapper in all policies — plan-cached, not per-row"
  - "Custom Access Token Hook injects restaurant_id and app_role — must be registered in Supabase Dashboard after deploy"
  - "UNIQUE(user_id) on restaurant_staff — enforces one restaurant per user for POC scope"
  - "Transaction log + denormalized balance pattern — balance_after in point_transactions + points_balance on customers"

patterns-established:
  - "Pattern: All tenant tables follow restaurant_id = (SELECT public.get_restaurant_id()) in FOR ALL policies"
  - "Pattern: Application code queries active_* views for reads; writes go to base tables"
  - "Pattern: No deleted_at in any RLS policy — filtering is view-layer only"

requirements-completed: [AUTH-05]

# Metrics
duration: 7min
completed: 2026-02-21
---

# Phase 1 Plan 01: Database Schema and RLS Summary

**Multi-tenant PostgreSQL schema with JWT-based RLS isolation and soft-delete views, verified with demo seed data on local Supabase**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-21T02:24:05Z
- **Completed:** 2026-02-21T02:31:36Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Created all 8 tables with restaurant_id, created_at, deleted_at on every table; app_role ENUM; correct FK ordering
- Implemented RLS tenant isolation policies using SECURITY DEFINER helper functions and JWT claim extraction with (SELECT ...) query plan caching
- Added Custom Access Token Hook that injects restaurant_id and app_role into every JWT at issuance
- Created 8 active_* views filtering soft-deleted rows without touching RLS (avoids the UPDATE re-validation conflict)
- Seeded demo restaurant with 5 customers, 4 ranks (Bronze/Prata/Gold/VIP), 2 reward configs, and 6 point_transactions
- Verified: supabase db reset runs cleanly, all tables show RLS enabled, soft-delete view filtering confirmed working

## Task Commits

Each task was committed atomically:

1. **Task 1: Create database schema migration with all tables** - `3d3f841` (feat)
2. **Task 2: Create RLS policies, helper functions, soft-delete views, and seed data** - `333ff7a` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `supabase/config.toml` - Supabase project configuration (auto-generated by supabase init)
- `supabase/migrations/0001_schema.sql` - 8 tables with FK ordering, indexes, app_role enum, RLS enable
- `supabase/migrations/0002_rls.sql` - get_restaurant_id(), get_app_role(), custom_access_token_hook, tenant_isolation_* policies
- `supabase/migrations/0003_views.sql` - 8 active_* views filtering deleted_at IS NULL
- `supabase/seed.sql` - Demo restaurant, ranks, rewards, customers, transactions using explicit UUIDs in DO block

## Decisions Made
- Soft-delete filtering via views, not RLS — avoids UPDATE re-validation conflict where setting deleted_at would fail because the row becomes invisible to the re-evaluating SELECT policy
- (SELECT public.get_restaurant_id()) wrapper in all policies — documented to prevent per-row JWT parsing; query planner caches result once per statement
- Custom Access Token Hook included in 0002_rls.sql — must be registered in Supabase Dashboard (Authentication → Hooks → Custom Access Token) on any deployed instance
- UNIQUE(user_id) constraint enforces one-restaurant-per-user for POC; dropping it later enables multi-restaurant managers

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Supabase CLI used `unix:///var/run/docker.sock` socket path but the OrbStack Docker daemon wasn't on the path supabase expected. Fixed by using `DOCKER_HOST=unix:///var/run/docker.sock` prefix. This is an environment-specific issue, not a plan deviation.

## User Setup Required

**Required before auth flow works end-to-end:**

The Custom Access Token Hook in `0002_rls.sql` must be registered in the Supabase Dashboard after deploying to any Supabase project (local or cloud):
1. Go to Authentication → Hooks
2. Enable "Custom Access Token Hook"
3. Select `public.custom_access_token_hook`

Without this, JWT claims will not contain `restaurant_id` or `app_role`, and all RLS policies will return empty results for authenticated users.

## Next Phase Readiness
- Database schema is complete and verified — all subsequent phases can reference these tables
- RLS isolation is working; cross-tenant test suite (Vitest SDK tests) is deferred to a later plan per ROADMAP
- Auth hook is implemented in SQL but needs Dashboard registration — document this in Phase 2 auth setup

---
*Phase: 01-foundation*
*Completed: 2026-02-21*
